<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sale Order 2 - 재고 확인 및 출고 처리</title>
  </head>
  <body>
    <h2>Sale Order 2. 재고 확인 및 출고 처리</h2>

    <div>
      <button id="approveBtn">주문 승인</button>
      <button id="allocateBtn">재고 할당</button>
      <button id="pickBtn">피킹 완료</button>
      <button id="shipBtn">출고 완료</button>
      <button id="invoiceBtn">송장 발행</button>
    </div>

    <div>
      <p>주문 상태: <span id="status">승인됨</span></p>
      <p>주문 번호: <span id="orderNo">SO202500001</span></p>
      <p>재고 상태: <span id="inventory">확인 필요</span></p>
      <p>할당 수량: <span id="allocated">0 / 100</span></p>
      <p>피킹 상태: <span id="picking">대기</span></p>
      <p>송장 번호: <span id="invoice">-</span></p>
    </div>

    <script type="module">
      import {
        createMachine,
        assign,
        createActor,
        fromPromise,
      } from "https://cdn.skypack.dev/xstate@5";

      console.log("XState v5 로드 완료:", {
        createMachine,
        assign,
        createActor,
        fromPromise,
      });
      const fulfillmentMachine = createMachine({
        id: "fulfillment",
        initial: "approved",
        context: {
          orderNo: "SO202500001",
          totalQty: 100,
          allocatedQty: 0,
          pickedQty: 0,
          invoiceNo: null,
        },
        states: {
          approved: {
            on: {
              ALLOCATE: "allocatingStock",
            },
          },
          allocatingStock: {
            invoke: {
              src: fromPromise(
                () =>
                  new Promise((resolve, reject) => {
                    setTimeout(() => {
                      Math.random() > 0.2
                        ? resolve({ allocated: 100 })
                        : reject("재고 부족");
                    }, 1500);
                  })
              ),
              onDone: {
                target: "stockAllocated",
                actions: assign({
                  allocatedQty: ({ event }) => event.output.allocated,
                }),
              },
              onError: "stockShortage",
            },
          },
          stockAllocated: {
            on: {
              PICK: "picking",
            },
          },
          picking: {
            invoke: {
              src: fromPromise(
                () =>
                  new Promise((resolve) => {
                    setTimeout(() => resolve({ picked: 100 }), 2000);
                  })
              ),
              onDone: {
                target: "picked",
                actions: assign({
                  pickedQty: ({ event }) => event.output.picked,
                }),
              },
            },
          },
          picked: {
            on: {
              SHIP: "shipping",
            },
          },
          shipping: {
            invoke: {
              src: fromPromise(
                () =>
                  new Promise((resolve) => {
                    setTimeout(() => resolve(), 1000);
                  })
              ),
              onDone: "shipped",
            },
          },
          shipped: {
            on: {
              INVOICE: {
                target: "invoiced",
                actions: assign({
                  invoiceNo: () => "INV" + Date.now().toString().substr(-6),
                }),
              },
            },
          },
          invoiced: {
            type: "final",
          },
          stockShortage: {
            on: {
              ALLOCATE: "allocatingStock",
            },
          },
        },
      });

      // XState v5에서는 createActor를 사용
      const actor = createActor(fulfillmentMachine);
      actor.start();

      function updateUI() {
        const currentState = actor.getSnapshot();

        const statusMap = {
          approved: "승인됨",
          allocatingStock: "재고 할당중...",
          stockAllocated: "재고 할당 완료",
          picking: "피킹중...",
          picked: "피킹 완료",
          shipping: "출고중...",
          shipped: "출고 완료",
          invoiced: "송장 발행 완료",
          stockShortage: "재고 부족",
        };

        document.getElementById("status").textContent =
          statusMap[currentState.value];
        document.getElementById("orderNo").textContent =
          currentState.context.orderNo;

        // 재고 상태
        if (currentState.matches("allocatingStock")) {
          document.getElementById("inventory").textContent = "확인중...";
        } else if (
          currentState.matches("stockAllocated") ||
          currentState.matches("picked") ||
          currentState.matches("shipped") ||
          currentState.matches("invoiced")
        ) {
          document.getElementById("inventory").textContent = "할당 완료 ✓";
        } else if (currentState.matches("stockShortage")) {
          document.getElementById("inventory").textContent = "재고 부족 ✗";
        } else {
          document.getElementById("inventory").textContent = "확인 필요";
        }

        // 할당 수량
        document.getElementById(
          "allocated"
        ).textContent = `${currentState.context.allocatedQty} / ${currentState.context.totalQty}`;

        // 피킹 상태
        if (currentState.matches("picking")) {
          document.getElementById("picking").textContent = "피킹중...";
        } else if (
          currentState.matches("picked") ||
          currentState.matches("shipped") ||
          currentState.matches("invoiced")
        ) {
          document.getElementById("picking").textContent = "완료 ✓";
        } else {
          document.getElementById("picking").textContent = "대기";
        }

        // 송장 번호
        document.getElementById("invoice").textContent =
          currentState.context.invoiceNo || "-";

        // 버튼 활성화
        document.getElementById("approveBtn").style.display = "none";
        document.getElementById("allocateBtn").disabled =
          !currentState.matches("approved") &&
          !currentState.matches("stockShortage");
        document.getElementById("pickBtn").disabled =
          !currentState.matches("stockAllocated");
        document.getElementById("shipBtn").disabled =
          !currentState.matches("picked");
        document.getElementById("invoiceBtn").disabled =
          !currentState.matches("shipped");
      }

      // 상태 변화 감지
      actor.subscribe(updateUI);

      function send(event) {
        actor.send({ type: event });
      }

      document.getElementById("allocateBtn").onclick = () => send("ALLOCATE");
      document.getElementById("pickBtn").onclick = () => send("PICK");
      document.getElementById("shipBtn").onclick = () => send("SHIP");
      document.getElementById("invoiceBtn").onclick = () => send("INVOICE");

      updateUI();
    </script>
  </body>
</html>
